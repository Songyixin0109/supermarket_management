{% extends "layout/layout_"|add:request.session.info.role|add:".html" %}
{% block content %}
<div class="container">
    <div class="search-bar">
        <div style="float: right;width: 300px">
            <form method="get">
                <div class="input-group">
                    <input type="text" name="search_data" class="form-control" placeholder="搜索..."
                        value="{{ search_data }}">
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="submit"><span
                                class="glyphicon glyphicon-search"></span></button>
                    </span>
                </div>
            </form>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading"><span class="glyphicon glyphicon-list-alt"></span> {{ title }}</div>
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>用户</th>
                    <th>商品</th>
                    <th>数量</th>
                    <th>下单时间</th>
                    <th>状态</th>
                    <th>更新时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for obj in sell_orders %}
                <tr>
                    <td>{{ obj.id }}</td>
                    <td>{{ obj.user.username }}</td>
                    <td>{{ obj.inventory_items.items_name.name|default:"-" }}</td>
                    <td>{{ obj.order_quantity }}</td>
                    <td>{{ obj.order_date|date:"Y-m-d H:i" }}</td>
                    <td class="col-status">
                        <span class="status-{{ obj.status }}">
                            {{ obj.get_status_display }}
                        </span>
                    </td>
                    <td>{{ obj.updated_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        <button type="button" class="btn btn-c-primary btn-xs btn-sell-edit" data-nid="{{ obj.id }}">
                            编 辑
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center text-muted">暂无订单</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <nav aria-label="Page navigation">
        <ul class="pagination">{{ page_string }}</ul>
    </nav>
</div>

<!-- ===== 编辑弹窗（直接写在这里） ===== -->
<div class="modal fade" id="sellEditModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">编辑订单（仅状态可改）</h4>
            </div>
            <form id="sellEditForm" class="form-horizontal" method="post" novalidate>
                {% csrf_token %}
                <div class="modal-body" id="modalBody">
                    <!-- JS 动态插入 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-c-danger" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-c-primary" id="btnSellSave">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
$(function () {
    let nidGlobal;

    $('.btn-sell-edit').on('click', function () {
        nidGlobal = $(this).data('nid');

        $.getJSON('/sellorder/admin/edit/' + nidGlobal + '/', function (res) {
            if (res.status) {
                $('#modalBody').empty();   

                Object.keys(res.fields).forEach(function (key) {
                    if (key === '状态可选值') return;   

                    const readonly = (key !== '状态');
                    const isSelect = (key === '状态');
                    let html = `
                      <div class="form-group">
                        <label class="col-sm-3 control-label">${key}</label>
                        <div class="col-sm-8">
                          ${isSelect
                            ? `<select name="status" class="form-control">
                                 ${res.fields['状态可选值'].map(
                                    ([v, l]) => `<option value="${v}" ${v===res.fields['状态']?'selected':''}>${l}</option>`
                                 ).join('')}
                               </select>`
                            : `<input type="text" class="form-control" value="${res.fields[key]}" ${readonly?'disabled':''}>`
                          }
                          <span class="error-msg" style="color:red;"></span>
                        </div>
                      </div>`;
                    $('#modalBody').append(html);
                });

                $('#sellEditModal').modal('show');
            } else {
                alert(res.error || '加载失败');
            }
        });
    });

    // 保存按钮
    $('#btnSellSave').off().on('click', function () {
        const $btn = $(this);
        if ($btn.prop('disabled')) return;
        $btn.prop('disabled', true).text('保存中…');
        $('.error-msg').text('');

        $.ajax({
            url: '/sellorder/admin/edit/' + nidGlobal + '/',
            type: 'post',
            data: $('#sellEditForm').serialize(),
            dataType: 'json',
            success: function (res) {
                if (res.status) {
                    alert(res.msg || '状态已更新');
                    $('#sellEditModal').modal('hide');
                    location.reload();
                } else {
                    $.each(res.error, function (k, v) {
                        $('#id_' + k).next('.error-msg').text(v[0]);
                    });
                }
            },
            complete: function () {
                $btn.prop('disabled', false).text('保存');
            }
        });
    });
});
</script>
{% endblock %}